name: Clear Environments

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  id-token: write
  contents: read

env:
  DB_NAME: realworld-app
  ORG_NAME: santunioni
  PLANETSCALE_SERVICE_TOKEN_ID: ${{ secrets.PLANETSCALE_TOKEN_ID }}
  PLANETSCALE_SERVICE_TOKEN: ${{ secrets.PLANETSCALE_TOKEN }}

jobs:
  list:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/credentials
      - run: |
          KEYS=$(aws s3api list-objects --bucket santunioni-iac-state --prefix env:/ --output json --query 'Contents[*].Key' | jq '[.[] | select(. | test("realworld-app\/\\w+.tfstate$"))]')
          TERRAFORM_WORKSPACES=$(echo $KEYS | jq '[.[] | sub("^env:\/";"") | sub("\/realworld-app\/\\w+.tfstate$";"")]')
          echo "ENVIRONMENTS=$(echo $TERRAFORM_WORKSPACES | jq -r tostring)" >> $GITHUB_OUTPUT
        shell: bash
        id: list
    outputs:
      environments: ${{ steps.list.outputs.ENVIRONMENTS }}

  clear:
    needs: list
    strategy:
      matrix:
        environment: ${{ fromJson(needs.list.outputs.environments) }}
    uses: ./.github/workflows/clear.yaml
    with:
      environment: ${{ matrix.environment }}
